"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("react"),t=require("crypto-js"),r=require("jwt-decode");function o(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var s=o(e),n=o(r);const i=process.env.KINDE_SITE_URL,a=process.env.NEXT_PUBLIC_KINDE_AUTH_API_PATH||process.env.KINDE_AUTH_API_PATH||"/api/auth",c=process.env.KINDE_POST_LOGIN_REDIRECT_URL||process.env.KINDE_POST_LOGIN_URL_REDIRECT_URL,u=process.env.KINDE_POST_LOGOUT_REDIRECT_URL,d={apiPath:a,initialState:{user:null,isLoading:!0,checkSession:null},SESSION_PREFIX:"pkce-verifier",redirectURL:i,postLoginRedirectURL:c,issuerURL:process.env.KINDE_ISSUER_URL,clientID:process.env.KINDE_CLIENT_ID,clientSecret:process.env.KINDE_CLIENT_SECRET,postLogoutRedirectURL:u,audience:process.env.KINDE_AUDIENCE,responseType:"code",scope:"openid profile email offline",codeChallengeMethod:"S256",redirectRoutes:{callback:`${a}/kinde_callback`},issuerRoutes:{logout:"/logout",login:"/oauth2/auth",register:"/oauth2/auth",token:"/oauth2/token",profile:"/oauth2/v2/user_profile"}},l={s:"string",i:"integer",b:"boolean"},g=()=>{throw new Error("Oops! Seems like you forgot to wrap your app in <KindeProvider>.")},_=e.createContext({...d.initialState,user:g,isLoading:g,getToken:g}),{getRandomValues:p}=require("uncrypto"),k=()=>{const e=new Uint8Array(28);return p(e),Array.from(e).map((e=>e.toString(16).padStart(2,"0"))).join("")};function h(){const e=k(),r=function(e){return t.SHA256(e).toString(t.enc.Base64url)}(e);return{code_verifier:e,code_challenge:r}}const f=require("cookie"),y=(e,t)=>`${e.endsWith("/")?e.slice(0,-1):e}/${t.startsWith("/")?t.substr(1):t}`;const R=(e,t="login",r)=>{const{code_challenge:o,code_verifier:s,state:n}=((e,t)=>{const r=k(),{code_challenge:o,code_verifier:s}=h();return{state:r,code_challenge:o,code_verifier:s}})();return((e,t,r,o)=>{const s=JSON.stringify({code_verifier:t,options:o});r.setHeader("Set-Cookie",f.serialize(`${d.SESSION_PREFIX}-${e}`,s,{httpOnly:!0,maxAge:900}))})(n,s,r,e),e.state=n,e.code_challenge=o,function(e,t="login"){const{org_code:r,is_create_org:o,org_name:s=""}=e,n=new URL(d.issuerURL+d.issuerRoutes[t]);let i={redirect_uri:y(d.redirectURL,d.redirectRoutes.callback),client_id:d.clientID,response_type:d.responseType,scope:d.scope,code_challenge:e.code_challenge,code_challenge_method:d.codeChallengeMethod,state:e.state};return"register"===t&&(i.start_page="registration"),r&&(i.org_code=r),o&&(i.is_create_org=o,i.org_name=s),d.audience&&(i.audience=d.audience),n.search=new URLSearchParams(i),n}(e,t).href},m=async(e,t)=>{const r=e.query,o=R(r,"login",t);t.redirect(o)};var v=require("cookie");const S=async(e,t)=>{t.setHeader("Set-Cookie",v.serialize("kinde_token",null,{httpOnly:!0,expires:new Date(0),sameSite:"lax",secure:"https:"==d.redirectURL.substring(0,6),path:"/"}));const r=new URL(d.issuerURL+d.issuerRoutes.logout);r.searchParams.set("redirect",d.postLogoutRedirectURL),t.redirect(r.href)};var L=require("cookie");const U=async(e,t)=>{const r=L.parse(e.headers.cookie||"").kinde_token;if(r){const e=JSON.parse(r);try{const r=await fetch(d.issuerURL+d.issuerRoutes.profile,{headers:new Headers({Authorization:"Bearer "+e.access_token})}),o=await r.json();t.send(o)}catch(e){console.error(e)}}else t.status(401).send({message:"Unauthorized"})},E=async(e,t)=>{const r=e.query,o=R(r,"register",t);t.redirect(o)},w=e=>{const t=e&&e.access_token||e;if(!t)return!1;const r=n.default(t,{header:!0}),o=n.default(t);let s=!0;return d.audience&&(s=o.aud&&o.aud.includes(d.audience)),!!(o.iss==d.issuerURL&&"RS256"==r.alg&&o.exp>Math.floor(Date.now()/1e3)&&s)};var I=require("cookie");const T=async(e,t)=>{const{code:r,state:o}=e.query,s=I.parse(e.headers.cookie||"")[`${d.SESSION_PREFIX}-${o}`];let i=d.postLoginRedirectURL||d.redirectURL;if(s){try{const{code_verifier:e,options:o}=JSON.parse(s);o?.post_login_redirect_url&&(i=(({baseUrl:e,url:t})=>t.startsWith("/")?`${e}${t}`:new URL(t).origin===e?t:e)({baseUrl:new URL(d.redirectURL).origin,url:o.post_login_redirect_url}));const a=await fetch(d.issuerURL+d.issuerRoutes.token,{method:"POST",headers:new Headers({"Content-type":"application/x-www-form-urlencoded; charset=UTF-8","Kinde-SDK":'"NextJS"/1.8.25'}),body:new URLSearchParams({client_id:d.clientID,client_secret:d.clientSecret,code:r,code_verifier:e,grant_type:"authorization_code",redirect_uri:y(d.redirectURL,d.redirectRoutes.callback)})}),c=await a.json(),u=n.default(c.access_token);w(c)?t.setHeader("Set-Cookie",I.serialize("kinde_token",JSON.stringify(c),{httpOnly:!0,expires:new Date(1e3*u.exp),sameSite:"lax",secure:"https:"==d.redirectURL.substring(0,6),path:"/"})):console.error("One or more of the claims were not verified.")}catch(e){console.error(e)}t.redirect(i)}else{const e=new URL(d.issuerURL+d.issuerRoutes.logout);e.searchParams.set("redirect",d.postLogoutRedirectURL),t.redirect(e.href)}},O=async(e,t)=>{const{org_name:r=""}=e.query.options,o=R({org_name:r,is_create_org:!0},"register",t);t.redirect(o)},C=async(e,t)=>{e.cookies.kinde_token?t.status(200).json(JSON.parse(e.cookies.kinde_token)):t.status(500).json({message:"There is no kinde_token, you are not authenticated. Try logging in."})},P=require("cookie"),N=async(e,t)=>{t.setHeader("Cache-Control","no-cache");const r=P.parse(e.headers.cookie||"").kinde_token;if(r){const e=JSON.parse(r),o=n.default(e.access_token),s=n.default(e.id_token);t.send({access_token_encoded:e.access_token,id_token:s,access_token:o})}else t.status(401).send({message:"Unauthorized"})};const x=(e,t)=>{if(e.cookies.kinde_token){return n.default(JSON.parse(e.cookies.kinde_token).access_token)}return{message:"There is no kinde_token, you are not authenticated. Try logging in."}},F=(e,t)=>{if(e.cookies.kinde_token){return n.default(JSON.parse(e.cookies.kinde_token).id_token)}return{message:"There is no kinde_token, you are not authenticated. Try logging in."}},b=(e,t,r)=>{const o=x(e);return o?o[r]:null},D={s:"string",i:"integer",b:"boolean"},A=(e,t,r)=>{const o=b("feature_flags"),s=o&&o[e]?o[e]:{};if(s=={}&&null==t)throw Error(`Flag ${e} was not found, and no default value has been provided`);if(r&&s.t&&r!==s.t)throw Error(`Flag ${e} is of type ${D[s.t]} - requested type ${D[r]}`);return{code:e,type:D[s.t||r],value:null==s.v?t:s.v,is_default:null==s.v}};exports.KindeProvider=({children:t})=>{const[r,o]=e.useState({...d.initialState,getToken:()=>null}),n=`${d.apiPath}/setup`,i=e.useCallback((async()=>{try{const e=await(async e=>{let t;try{t=await fetch(e)}catch{throw new RequestError(0)}if(t.ok)return await t.json();t.status})(n),t={id:e.id_token.sub,name:e.id_token.name,given_name:e.id_token.given_name,family_name:e.id_token.family_name,updated_at:e.id_token.updated_at,email:e.id_token.email,picture:e.id_token.picture},r=(t,r="access_token")=>{const o="access_token"===r?e.access_token:e.id_token;return o?{name:t,value:o[t]}:null},s=(e,t="access_token")=>{const o=r(e,t);return o&&o.value},i=(e,t,r)=>{const o=s("feature_flags"),n=o&&o[e]?o[e]:{};if(n=={}&&null==t)throw Error(`Flag ${e} was not found, and no default value has been provided`);if(r&&n.t&&r!==n.t)throw Error(`Flag ${e} is of type ${l[n.t]} - requested type ${l[r]}`);return{code:e,type:l[n.t||r],value:null==n.v?t:n.v,is_default:null==n.v}},a=(e,t)=>{try{return i(e,t,"b").value}catch(e){console.error(e)}},c=(e,t)=>{try{return i(e,t,"s").value}catch(e){console.error(e)}},u=(e,t)=>{try{return i(e,t,"i").value}catch(e){console.error(e)}},d=()=>{const e=s("org_code");return{permissions:s("permissions"),orgCode:e}},g=e=>{const t=s("org_code");return{isGranted:(s("permissions")||[]).some((t=>t===e)),orgCode:t}},_=()=>({orgCode:s("org_code")}),p=()=>({orgCodes:s("org_codes","id_token")}),k=()=>e&&e.access_token_encoded?e.access_token_encoded:void 0;o((e=>({...e,user:t,getToken:k,getClaim:r,getFlag:i,getBooleanFlag:a,getStringFlag:c,getIntegerFlag:u,getPermissions:d,getPermission:g,getOrganization:_,getUserOrganizations:p,error:void 0})))}catch(e){o((t=>({...t,isLoading:!1,error:e})))}}),[n]);e.useEffect((()=>{r.user||(async()=>{await i(),o((e=>({...e,isLoading:!1})))})()}),[r.user]);const{user:a,getToken:c,getClaim:u,getFlag:g,getBooleanFlag:p,getStringFlag:k,getIntegerFlag:h,getPermissions:f,getPermission:y,getOrganization:R,getUserOrganizations:m,error:v,isLoading:S}=r;return s.default.createElement(_.Provider,{value:{user:a,error:v,getToken:c,getClaim:u,getFlag:g,getBooleanFlag:p,getStringFlag:k,getIntegerFlag:h,getPermissions:f,getPermission:y,getOrganization:R,getUserOrganizations:m,isLoading:S,isAuthenticated:!!a}},t)},exports.getAccessToken=x,exports.getBooleanFlag=(e,t)=>{try{return A(e,t,"b").value}catch(e){console.error(e)}},exports.getFlag=A,exports.getIdToken=F,exports.getIntegerFlag=(e,t)=>{try{return A(e,t,"i").value}catch(e){console.error(e)}},exports.getOrganization=(e,t)=>({orgCode:b(e,0,"org_code")}),exports.getPermission=(e,t,r)=>{const o=b(e,0,"org_code");return{isGranted:(b(e,0,"permissions")||[]).some((e=>e===r)),orgCode:o}},exports.getPermissions=(e,t)=>{const r=b(e,0,"org_code");return{permissions:b(e,0,"permissions"),orgCode:r}},exports.getStringFlag=(e,t)=>{try{return A(e,t,"s").value}catch(e){console.error(e)}},exports.getUserOrganizations=(e,t)=>{const r=((e,t,r)=>{const o=F(e);return o?o[r]:null})(e,0,"org_codes");return{orgCodes:r}},exports.handleAuth=()=>async function(e,t){let{query:{kindeAuth:r}}=e;r=Array.isArray(r)?r[0]:r;const o=(e=>({create_org:O,get_token:C,kinde_callback:T,login:m,logout:S,me:U,register:E,setup:N}[e]))(r);return o?await o(e,t):t.status(404).end()},exports.isTokenValid=w,exports.useKindeAuth=()=>e.useContext(_);
//# sourceMappingURL=index.js.map
