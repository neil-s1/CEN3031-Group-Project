import e,{useContext as t,useState as r,useCallback as o,useEffect as n,createContext as s}from"react";import{SHA256 as i,enc as a}from"crypto-js";import c from"jwt-decode";const d=process.env.KINDE_SITE_URL,u=process.env.NEXT_PUBLIC_KINDE_AUTH_API_PATH||process.env.KINDE_AUTH_API_PATH||"/api/auth",l=process.env.KINDE_POST_LOGIN_REDIRECT_URL||process.env.KINDE_POST_LOGIN_URL_REDIRECT_URL,g=process.env.KINDE_POST_LOGOUT_REDIRECT_URL,_={apiPath:u,initialState:{user:null,isLoading:!0,checkSession:null},SESSION_PREFIX:"pkce-verifier",redirectURL:d,postLoginRedirectURL:l,issuerURL:process.env.KINDE_ISSUER_URL,clientID:process.env.KINDE_CLIENT_ID,clientSecret:process.env.KINDE_CLIENT_SECRET,postLogoutRedirectURL:g,audience:process.env.KINDE_AUDIENCE,responseType:"code",scope:"openid profile email offline",codeChallengeMethod:"S256",redirectRoutes:{callback:`${u}/kinde_callback`},issuerRoutes:{logout:"/logout",login:"/oauth2/auth",register:"/oauth2/auth",token:"/oauth2/token",profile:"/oauth2/v2/user_profile"}},p={s:"string",i:"integer",b:"boolean"},k=()=>{throw new Error("Oops! Seems like you forgot to wrap your app in <KindeProvider>.")},h=s({..._.initialState,user:k,isLoading:k,getToken:k}),m=()=>t(h),f=({children:t})=>{const[s,i]=r({..._.initialState,getToken:()=>null}),a=`${_.apiPath}/setup`,c=o((async()=>{try{const e=await(async e=>{let t;try{t=await fetch(e)}catch{throw new RequestError(0)}if(t.ok)return await t.json();t.status})(a),t={id:e.id_token.sub,name:e.id_token.name,given_name:e.id_token.given_name,family_name:e.id_token.family_name,updated_at:e.id_token.updated_at,email:e.id_token.email,picture:e.id_token.picture},r=(t,r="access_token")=>{const o="access_token"===r?e.access_token:e.id_token;return o?{name:t,value:o[t]}:null},o=(e,t="access_token")=>{const o=r(e,t);return o&&o.value},n=(e,t,r)=>{const n=o("feature_flags"),s=n&&n[e]?n[e]:{};if(s=={}&&null==t)throw Error(`Flag ${e} was not found, and no default value has been provided`);if(r&&s.t&&r!==s.t)throw Error(`Flag ${e} is of type ${p[s.t]} - requested type ${p[r]}`);return{code:e,type:p[s.t||r],value:null==s.v?t:s.v,is_default:null==s.v}},s=(e,t)=>{try{return n(e,t,"b").value}catch(e){console.error(e)}},c=(e,t)=>{try{return n(e,t,"s").value}catch(e){console.error(e)}},d=(e,t)=>{try{return n(e,t,"i").value}catch(e){console.error(e)}},u=()=>{const e=o("org_code");return{permissions:o("permissions"),orgCode:e}},l=e=>{const t=o("org_code");return{isGranted:(o("permissions")||[]).some((t=>t===e)),orgCode:t}},g=()=>({orgCode:o("org_code")}),_=()=>({orgCodes:o("org_codes","id_token")}),k=()=>e&&e.access_token_encoded?e.access_token_encoded:void 0;i((e=>({...e,user:t,getToken:k,getClaim:r,getFlag:n,getBooleanFlag:s,getStringFlag:c,getIntegerFlag:d,getPermissions:u,getPermission:l,getOrganization:g,getUserOrganizations:_,error:void 0})))}catch(e){i((t=>({...t,isLoading:!1,error:e})))}}),[a]);n((()=>{s.user||(async()=>{await c(),i((e=>({...e,isLoading:!1})))})()}),[s.user]);const{user:d,getToken:u,getClaim:l,getFlag:g,getBooleanFlag:k,getStringFlag:m,getIntegerFlag:f,getPermissions:y,getPermission:R,getOrganization:v,getUserOrganizations:L,error:S,isLoading:U}=s;return e.createElement(h.Provider,{value:{user:d,error:S,getToken:u,getClaim:l,getFlag:g,getBooleanFlag:k,getStringFlag:m,getIntegerFlag:f,getPermissions:y,getPermission:R,getOrganization:v,getUserOrganizations:L,isLoading:U,isAuthenticated:!!d}},t)},{getRandomValues:y}=require("uncrypto"),R=()=>{const e=new Uint8Array(28);return y(e),Array.from(e).map((e=>e.toString(16).padStart(2,"0"))).join("")};function v(){const e=R(),t=function(e){return i(e).toString(a.Base64url)}(e);return{code_verifier:e,code_challenge:t}}const L=require("cookie"),S=(e,t)=>`${e.endsWith("/")?e.slice(0,-1):e}/${t.startsWith("/")?t.substr(1):t}`;const U=(e,t="login",r)=>{const{code_challenge:o,code_verifier:n,state:s}=((e,t)=>{const r=R(),{code_challenge:o,code_verifier:n}=v();return{state:r,code_challenge:o,code_verifier:n}})();return((e,t,r,o)=>{const n=JSON.stringify({code_verifier:t,options:o});r.setHeader("Set-Cookie",L.serialize(`${_.SESSION_PREFIX}-${e}`,n,{httpOnly:!0,maxAge:900}))})(s,n,r,e),e.state=s,e.code_challenge=o,function(e,t="login"){const{org_code:r,is_create_org:o,org_name:n=""}=e,s=new URL(_.issuerURL+_.issuerRoutes[t]);let i={redirect_uri:S(_.redirectURL,_.redirectRoutes.callback),client_id:_.clientID,response_type:_.responseType,scope:_.scope,code_challenge:e.code_challenge,code_challenge_method:_.codeChallengeMethod,state:e.state};return"register"===t&&(i.start_page="registration"),r&&(i.org_code=r),o&&(i.is_create_org=o,i.org_name=n),_.audience&&(i.audience=_.audience),s.search=new URLSearchParams(i),s}(e,t).href},w=async(e,t)=>{const r=e.query,o=U(r,"login",t);t.redirect(o)};var E=require("cookie");const I=async(e,t)=>{t.setHeader("Set-Cookie",E.serialize("kinde_token",null,{httpOnly:!0,expires:new Date(0),sameSite:"lax",secure:"https:"==_.redirectURL.substring(0,6),path:"/"}));const r=new URL(_.issuerURL+_.issuerRoutes.logout);r.searchParams.set("redirect",_.postLogoutRedirectURL),t.redirect(r.href)};var T=require("cookie");const O=async(e,t)=>{const r=T.parse(e.headers.cookie||"").kinde_token;if(r){const e=JSON.parse(r);try{const r=await fetch(_.issuerURL+_.issuerRoutes.profile,{headers:new Headers({Authorization:"Bearer "+e.access_token})}),o=await r.json();t.send(o)}catch(e){console.error(e)}}else t.status(401).send({message:"Unauthorized"})},N=async(e,t)=>{const r=e.query,o=U(r,"register",t);t.redirect(o)},C=e=>{const t=e&&e.access_token||e;if(!t)return!1;const r=c(t,{header:!0}),o=c(t);let n=!0;return _.audience&&(n=o.aud&&o.aud.includes(_.audience)),!!(o.iss==_.issuerURL&&"RS256"==r.alg&&o.exp>Math.floor(Date.now()/1e3)&&n)};var P=require("cookie");const D=async(e,t)=>{const{code:r,state:o}=e.query,n=P.parse(e.headers.cookie||"")[`${_.SESSION_PREFIX}-${o}`];let s=_.postLoginRedirectURL||_.redirectURL;if(n){try{const{code_verifier:e,options:o}=JSON.parse(n);o?.post_login_redirect_url&&(s=(({baseUrl:e,url:t})=>t.startsWith("/")?`${e}${t}`:new URL(t).origin===e?t:e)({baseUrl:new URL(_.redirectURL).origin,url:o.post_login_redirect_url}));const i=await fetch(_.issuerURL+_.issuerRoutes.token,{method:"POST",headers:new Headers({"Content-type":"application/x-www-form-urlencoded; charset=UTF-8","Kinde-SDK":'"NextJS"/1.8.25'}),body:new URLSearchParams({client_id:_.clientID,client_secret:_.clientSecret,code:r,code_verifier:e,grant_type:"authorization_code",redirect_uri:S(_.redirectURL,_.redirectRoutes.callback)})}),a=await i.json(),d=c(a.access_token);C(a)?t.setHeader("Set-Cookie",P.serialize("kinde_token",JSON.stringify(a),{httpOnly:!0,expires:new Date(1e3*d.exp),sameSite:"lax",secure:"https:"==_.redirectURL.substring(0,6),path:"/"})):console.error("One or more of the claims were not verified.")}catch(e){console.error(e)}t.redirect(s)}else{const e=new URL(_.issuerURL+_.issuerRoutes.logout);e.searchParams.set("redirect",_.postLogoutRedirectURL),t.redirect(e.href)}},b=async(e,t)=>{const{org_name:r=""}=e.query.options,o=U({org_name:r,is_create_org:!0},"register",t);t.redirect(o)},F=async(e,t)=>{e.cookies.kinde_token?t.status(200).json(JSON.parse(e.cookies.kinde_token)):t.status(500).json({message:"There is no kinde_token, you are not authenticated. Try logging in."})},$=require("cookie"),A=async(e,t)=>{t.setHeader("Cache-Control","no-cache");const r=$.parse(e.headers.cookie||"").kinde_token;if(r){const e=JSON.parse(r),o=c(e.access_token),n=c(e.id_token);t.send({access_token_encoded:e.access_token,id_token:n,access_token:o})}else t.status(401).send({message:"Unauthorized"})};var q=()=>async function(e,t){let{query:{kindeAuth:r}}=e;r=Array.isArray(r)?r[0]:r;const o=(e=>({create_org:b,get_token:F,kinde_callback:D,login:w,logout:I,me:O,register:N,setup:A}[e]))(r);return o?await o(e,t):t.status(404).end()};const z=(e,t)=>{if(e.cookies.kinde_token){return c(JSON.parse(e.cookies.kinde_token).access_token)}return{message:"There is no kinde_token, you are not authenticated. Try logging in."}},K=(e,t)=>{if(e.cookies.kinde_token){return c(JSON.parse(e.cookies.kinde_token).id_token)}return{message:"There is no kinde_token, you are not authenticated. Try logging in."}},x=(e,t,r)=>{const o=z(e);return o?o[r]:null},H={s:"string",i:"integer",b:"boolean"},J=(e,t,r)=>{const o=x("feature_flags"),n=o&&o[e]?o[e]:{};if(n=={}&&null==t)throw Error(`Flag ${e} was not found, and no default value has been provided`);if(r&&n.t&&r!==n.t)throw Error(`Flag ${e} is of type ${H[n.t]} - requested type ${H[r]}`);return{code:e,type:H[n.t||r],value:null==n.v?t:n.v,is_default:null==n.v}},j=(e,t)=>{try{return J(e,t,"b").value}catch(e){console.error(e)}},B=(e,t)=>{try{return J(e,t,"i").value}catch(e){console.error(e)}},G=(e,t)=>({orgCode:x(e,0,"org_code")}),X=(e,t,r)=>{const o=x(e,0,"org_code");return{isGranted:(x(e,0,"permissions")||[]).some((e=>e===r)),orgCode:o}},M=(e,t)=>{const r=x(e,0,"org_code");return{permissions:x(e,0,"permissions"),orgCode:r}},W=(e,t)=>{try{return J(e,t,"s").value}catch(e){console.error(e)}},V=(e,t)=>{const r=((e,t,r)=>{const o=K(e);return o?o[r]:null})(e,0,"org_codes");return{orgCodes:r}};export{f as KindeProvider,z as getAccessToken,j as getBooleanFlag,J as getFlag,K as getIdToken,B as getIntegerFlag,G as getOrganization,X as getPermission,M as getPermissions,W as getStringFlag,V as getUserOrganizations,q as handleAuth,C as isTokenValid,m as useKindeAuth};
//# sourceMappingURL=index.js.map
