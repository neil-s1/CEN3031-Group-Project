"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("jwt-decode"),t=require("next/headers"),r=require("next/navigation"),o=require("crypto-js"),n=require("next/server"),s=require("react"),i=require("@kinde-oss/kinde-typescript-sdk");function a(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var c=a(e),l=a(s);const u=process.env.KINDE_SITE_URL,d=process.env.NEXT_PUBLIC_KINDE_AUTH_API_PATH||process.env.KINDE_AUTH_API_PATH||"/api/auth",p=process.env.KINDE_POST_LOGIN_REDIRECT_URL||process.env.KINDE_POST_LOGIN_URL_REDIRECT_URL,g=process.env.KINDE_POST_LOGOUT_REDIRECT_URL,_={apiPath:d,initialState:{user:null,isLoading:!0,checkSession:null},SESSION_PREFIX:"pkce-verifier",redirectURL:u,postLoginRedirectURL:p,issuerURL:process.env.KINDE_ISSUER_URL,clientID:process.env.KINDE_CLIENT_ID,clientSecret:process.env.KINDE_CLIENT_SECRET,postLogoutRedirectURL:g,audience:process.env.KINDE_AUDIENCE,responseType:"code",scope:"openid profile email offline",codeChallengeMethod:"S256",redirectRoutes:{callback:`${d}/kinde_callback`},issuerRoutes:{logout:"/logout",login:"/oauth2/auth",register:"/oauth2/auth",token:"/oauth2/token",profile:"/oauth2/v2/user_profile"}},h=(e,t)=>`${e.endsWith("/")?e.slice(0,-1):e}/${t.startsWith("/")?t.substr(1):t}`,{getRandomValues:f}=require("uncrypto"),R=()=>{const e=new Uint8Array(28);return f(e),Array.from(e).map((e=>e.toString(16).padStart(2,"0"))).join("")};function m(){const e=R(),t=function(e){return o.SHA256(e).toString(o.enc.Base64url)}(e);return{code_verifier:e,code_challenge:t}}const k=(e,r="login")=>{const{code_challenge:o,code_verifier:n,state:s}=((e,t)=>{const r=R(),{code_challenge:o,code_verifier:n}=m();return{state:r,code_challenge:o,code_verifier:n}})();return((e,r,o)=>{t.cookies().set({name:`${_.SESSION_PREFIX}-${e}`,value:JSON.stringify({code_verifier:r,options:o}),httpOnly:!0,path:"/",maxAge:900})})(s,n,e),e.state=s,e.code_challenge=o,function(e,t="login"){const{org_code:r,is_create_org:o,org_name:n=""}=e,s=new URL(_.issuerURL+_.issuerRoutes[t]);let i={redirect_uri:h(_.redirectURL,_.redirectRoutes.callback),client_id:_.clientID,response_type:_.responseType,scope:_.scope,code_challenge:e.code_challenge,code_challenge_method:_.codeChallengeMethod,state:e.state};return"register"===t&&(i.start_page="registration"),r&&(i.org_code=r),o&&(i.is_create_org=o,i.org_name=n),_.audience&&(i.audience=_.audience),s.search=new URLSearchParams(i),s}(e,r).href},S={create_org:async e=>{const t=e.nextUrl.searchParams.get("org_name"),o=k({org_name:t,is_create_org:!0},"register");r.redirect(o)},register:async e=>{const t=e.nextUrl.searchParams.get("org_code"),o=e.nextUrl.searchParams.get("post_login_redirect_url"),n=k({org_code:t,post_login_redirect_url:o},"register");r.redirect(n)},login:async e=>{const t=e.nextUrl.searchParams.get("org_code"),o=e.nextUrl.searchParams.get("post_login_redirect_url"),n=k({org_code:t,post_login_redirect_url:o});r.redirect(n)},logout:async e=>{t.cookies(),t.cookies().set({name:"kinde_token",value:"",httpOnly:!0,expires:new Date(0),sameSite:"lax",secure:"https:"==_.redirectURL.substring(0,6),path:"/"});const o=new URL(_.issuerURL+_.issuerRoutes.logout);o.searchParams.set("redirect",_.postLogoutRedirectURL||""),r.redirect(o.href)},kinde_callback:async e=>{const o=e.nextUrl.searchParams.get("code"),n=e.nextUrl.searchParams.get("state"),s=t.cookies().get(`${_.SESSION_PREFIX}-${n}`);let i=_.postLoginRedirectURL||_.redirectURL;if(s){const{code_verifier:e,options:n}=JSON.parse(s.value);n?.post_login_redirect_url&&(i=(({baseUrl:e,url:t})=>t.startsWith("/")?`${e}${t}`:new URL(t).origin===e?t:e)({baseUrl:new URL(_.redirectURL).origin,url:n.post_login_redirect_url}));try{const r=await fetch(_.issuerURL+_.issuerRoutes.token,{method:"POST",headers:new Headers({"Content-type":"application/x-www-form-urlencoded; charset=UTF-8","Kinde-SDK":'"NextJS"/1.8.25'}),body:new URLSearchParams({client_id:_.clientID,client_secret:_.clientSecret,code:o,code_verifier:e,grant_type:"authorization_code",redirect_uri:h(_.redirectURL,_.redirectRoutes.callback)})}),n=await r.json();console.log("look here",n);const s=c.default(n.access_token,{header:!0}),i=c.default(n.access_token);let a=!0;_.audience&&(a=i.aud&&i.aud.includes(_.audience)),i.iss===_.issuerURL&&"RS256"===s.alg&&i.exp>Math.floor(Date.now()/1e3)&&a?t.cookies().set({name:"kinde_token",value:JSON.stringify(n),httpOnly:!0,expires:new Date(1e3*i.exp),sameSite:"lax",secure:"https:"==_.redirectURL.substring(0,6),path:"/"}):console.error("One or more of the claims were not verified.")}catch(e){console.error({err:e})}r.redirect(i)}else{const e=new URL(_.issuerURL+_.issuerRoutes.logout);e.searchParams.set("redirect",_.postLogoutRedirectURL),r.redirect(e.href)}}};const L=e=>{const r=t.cookies().get("kinde_token");if(r){return c.default(JSON.parse(r.value).access_token)}return{message:"There is no kinde_token, you are not authenticated. Try logging in."}},U=e=>{const r=t.cookies().get("kinde_token");if(r){return c.default(JSON.parse(r.value).id_token)}},y=e=>{const t=L();return t?t[e]:null},v={s:"string",i:"integer",b:"boolean"},A=(e,t,r)=>{const o=y("feature_flags"),n=o&&o[e]?o[e]:{};if(n=={}&&null==t)throw Error(`Flag ${e} was not found, and no default value has been provided`);if(r&&n.t&&r!==n.t)throw Error(`Flag ${e} is of type ${v[n.t]} - requested type ${v[r]}`);return{code:e,type:v[n.t||r],value:null==n.v?t:n.v,is_default:null==n.v}},w=e=>{const t=U();return t?{id:t.sub,given_name:t.given_name,family_name:t.family_name,email:t.email,picture:t.picture}:void 0};var I=Object.freeze({__proto__:null,getAccessToken:L,getBooleanFlag:(e,t)=>{try{return A(e,t,"b").value}catch(e){console.error(e)}},getFlag:A,getIdToken:U,getIntegerFlag:(e,t)=>{try{return A(e,t,"i").value}catch(e){console.error(e)}},getOrganization:()=>({orgCode:y("org_code")}),getPermission:e=>{const t=y("org_code");return{isGranted:(y("permissions")||[]).some((t=>t===e)),orgCode:t}},getPermissions:()=>{const e=y("org_code");return{permissions:y("permissions"),orgCode:e}},getStringFlag:(e,t)=>{try{return A(e,t,"s").value}catch(e){console.error(e)}},getUserOrganizations:e=>({orgCodes:(e=>{const t=U();return t?t[e]:null})("org_codes")}),getUser:w,isAuthenticated:e=>Boolean(w())});const P=e=>e&&"/"===e.charAt(e.length-1)?e.slice(0,-1):e;function E(){return E=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var o in r)Object.prototype.hasOwnProperty.call(r,o)&&(e[o]=r[o])}return e},E.apply(this,arguments)}var b=require("cookie");const x=(e,r)=>e?(e=>e instanceof Request)(e)?O(t.cookies()):N(e,r):O(t.cookies()),O=e=>({getSessionItem:t=>{const r=e.get(t);if(r)try{const e=JSON.parse(r.value);return"object"==typeof e?e:r.value}catch(e){return r.value}},setSessionItem:(t,r)=>e.set(t,"object"==typeof r?JSON.stringify(r):r),removeSessionItem:t=>e.delete(t),destroySession:()=>{["id_token_payload","id_token","access_token_payload","access_token","user","refresh_token"].forEach((t=>e.delete(t)))}}),N=(e,t)=>({getSessionItem:t=>{const r=e.cookies[t];if(r)try{const e=JSON.parse(r);return"object"==typeof e?e:r}catch(e){return r}},setSessionItem:(e,r)=>{let o=t.getHeader("Set-Cookie")||[];Array.isArray(o)||(o=[o]),t.setHeader("Set-Cookie",[...o.filter((t=>!t.startsWith(`${e}=`))),b.serialize(e,"object"==typeof r?JSON.stringify(r):r,{path:"/"})])},removeSessionItem:e=>{t.setHeader("Set-Cookie",b.serialize(e,"",{path:"/",maxAge:-1}))},destroySession:()=>{t.setHeader("Set-Cookie",["id_token_payload","id_token","access_token_payload","access_token","user","refresh_token"].map((e=>b.serialize(e,"",{path:"/",maxAge:-1}))))}});exports.CreateOrgLink=function({children:e,orgName:t,...r}){return l.default.createElement("a",E({href:`${_.apiPath}/create_org${t?`?org_name=${t}`:""}`},r),e)},exports.LoginLink=function({children:e,postLoginRedirectURL:t,orgCode:r,...o}){let n=new URLSearchParams;return null!=r&&n.append("org_code",r),null!=t&&n.append("post_login_redirect_url",t),l.default.createElement("a",E({href:`${_.apiPath}/login${n?`?${n.toString()}`:""}`},o),e)},exports.LogoutLink=function({children:e,...t}){return l.default.createElement("a",E({href:`${_.apiPath}/logout`},t),e)},exports.RegisterLink=function({children:e,orgCode:t,postLoginRedirectURL:r,...o}){let n=new URLSearchParams;return null!=t&&n.append("org_code",t),null!=r&&n.append("post_login_redirect_url",r),l.default.createElement("a",E({href:`${_.apiPath}/register${n?`?${n.toString()}`:""}`},o),e)},exports.authMiddleware=function(e){let t=!1;const r=P(e.nextUrl.href),o=P(_.postLogoutRedirectURL),s=e.cookies.get("kinde_token"),i=r===o;return s&&(c.default(JSON.parse(s.value).access_token),t=!0),t||i?t&&i?n.NextResponse.redirect(new URL(_.postLoginRedirectURL)):n.NextResponse.next():n.NextResponse.redirect(new URL(_.postLogoutRedirectURL,e.url))},exports.createKindeManagementAPIClient=async(e,t)=>{let r=null;const o=x(e,t),n=o.getSessionItem("kinde_api_access_token");if((e=>{const t=e&&e.access_token||e;if(!t)return!1;const r=c.default(t,{header:!0}),o=c.default(t);let n=!0;return _.audience&&(n=o.aud&&o.aud.includes(_.audience)),!!(o.iss==_.issuerURL&&"RS256"==r.alg&&o.exp>Math.floor(Date.now()/1e3)&&n)})(n))r=n;else{const e=await fetch(`${_.issuerURL}/oauth2/token`,{method:"POST",headers:{"content-type":"application/x-www-form-urlencoded"},body:new URLSearchParams({grant_type:"client_credentials",client_id:_.clientID,client_secret:_.clientSecret,audience:_.audience})});r=(await e.json()).access_token,o.setSessionItem("kinde_api_access_token",r)}const s=new i.Configuration({basePath:_.issuerURL,accessToken:r,headers:{Accept:"application/json"}});return{usersApi:new i.UsersApi(s),oauthApi:new i.OAuthApi(s),subscribersApi:new i.SubscribersApi(s),organizationsApi:new i.OrganizationsApi(s),connectedAppsApi:new i.ConnectedAppsApi(s),featureFlagsApi:new i.FeatureFlagsApi(s),environmentsApi:new i.EnvironmentsApi(s),permissionsApi:new i.PermissionsApi(s),rolesApi:new i.RolesApi(s),businessApi:new i.BusinessApi(s),industriesApi:new i.IndustriesApi(s),timezonesApi:new i.TimezonesApi(s),applicationsApi:new i.ApplicationsApi(s),callbacksApi:new i.CallbacksApi(s),apisApi:new i.APIsApi(s)}},exports.getKindeServerSession=()=>I,exports.handleAuth=async function(e,t){const r=(e=>S[e])(t);return r?await r(e):new Response("This page could not be found.",{status:404})};
//# sourceMappingURL=index.js.map
