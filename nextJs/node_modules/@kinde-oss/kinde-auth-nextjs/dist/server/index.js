import e from"jwt-decode";import{cookies as t}from"next/headers";import{redirect as r}from"next/navigation";import{SHA256 as o,enc as n}from"crypto-js";import{NextResponse as s}from"next/server";import i from"react";import{Configuration as a,UsersApi as c,OAuthApi as l,SubscribersApi as u,OrganizationsApi as d,ConnectedAppsApi as _,FeatureFlagsApi as p,EnvironmentsApi as g,PermissionsApi as h,RolesApi as m,BusinessApi as f,IndustriesApi as R,TimezonesApi as S,ApplicationsApi as U,CallbacksApi as k,APIsApi as L}from"@kinde-oss/kinde-typescript-sdk";const y=process.env.KINDE_SITE_URL,v=process.env.NEXT_PUBLIC_KINDE_AUTH_API_PATH||process.env.KINDE_AUTH_API_PATH||"/api/auth",w=process.env.KINDE_POST_LOGIN_REDIRECT_URL||process.env.KINDE_POST_LOGIN_URL_REDIRECT_URL,I=process.env.KINDE_POST_LOGOUT_REDIRECT_URL,E={apiPath:v,initialState:{user:null,isLoading:!0,checkSession:null},SESSION_PREFIX:"pkce-verifier",redirectURL:y,postLoginRedirectURL:w,issuerURL:process.env.KINDE_ISSUER_URL,clientID:process.env.KINDE_CLIENT_ID,clientSecret:process.env.KINDE_CLIENT_SECRET,postLogoutRedirectURL:I,audience:process.env.KINDE_AUDIENCE,responseType:"code",scope:"openid profile email offline",codeChallengeMethod:"S256",redirectRoutes:{callback:`${v}/kinde_callback`},issuerRoutes:{logout:"/logout",login:"/oauth2/auth",register:"/oauth2/auth",token:"/oauth2/token",profile:"/oauth2/v2/user_profile"}},P=(e,t)=>`${e.endsWith("/")?e.slice(0,-1):e}/${t.startsWith("/")?t.substr(1):t}`,{getRandomValues:A}=require("uncrypto"),O=()=>{const e=new Uint8Array(28);return A(e),Array.from(e).map((e=>e.toString(16).padStart(2,"0"))).join("")};function b(){const e=O(),t=function(e){return o(e).toString(n.Base64url)}(e);return{code_verifier:e,code_challenge:t}}const N=(e,r="login")=>{const{code_challenge:o,code_verifier:n,state:s}=((e,t)=>{const r=O(),{code_challenge:o,code_verifier:n}=b();return{state:r,code_challenge:o,code_verifier:n}})();return((e,r,o)=>{t().set({name:`${E.SESSION_PREFIX}-${e}`,value:JSON.stringify({code_verifier:r,options:o}),httpOnly:!0,path:"/",maxAge:900})})(s,n,e),e.state=s,e.code_challenge=o,function(e,t="login"){const{org_code:r,is_create_org:o,org_name:n=""}=e,s=new URL(E.issuerURL+E.issuerRoutes[t]);let i={redirect_uri:P(E.redirectURL,E.redirectRoutes.callback),client_id:E.clientID,response_type:E.responseType,scope:E.scope,code_challenge:e.code_challenge,code_challenge_method:E.codeChallengeMethod,state:e.state};return"register"===t&&(i.start_page="registration"),r&&(i.org_code=r),o&&(i.is_create_org=o,i.org_name=n),E.audience&&(i.audience=E.audience),s.search=new URLSearchParams(i),s}(e,r).href},T={create_org:async e=>{const t=e.nextUrl.searchParams.get("org_name"),o=N({org_name:t,is_create_org:!0},"register");r(o)},register:async e=>{const t=e.nextUrl.searchParams.get("org_code"),o=e.nextUrl.searchParams.get("post_login_redirect_url"),n=N({org_code:t,post_login_redirect_url:o},"register");r(n)},login:async e=>{const t=e.nextUrl.searchParams.get("org_code"),o=e.nextUrl.searchParams.get("post_login_redirect_url"),n=N({org_code:t,post_login_redirect_url:o});r(n)},logout:async e=>{t(),t().set({name:"kinde_token",value:"",httpOnly:!0,expires:new Date(0),sameSite:"lax",secure:"https:"==E.redirectURL.substring(0,6),path:"/"});const o=new URL(E.issuerURL+E.issuerRoutes.logout);o.searchParams.set("redirect",E.postLogoutRedirectURL||""),r(o.href)},kinde_callback:async o=>{const n=o.nextUrl.searchParams.get("code"),s=o.nextUrl.searchParams.get("state"),i=t().get(`${E.SESSION_PREFIX}-${s}`);let a=E.postLoginRedirectURL||E.redirectURL;if(i){const{code_verifier:o,options:s}=JSON.parse(i.value);s?.post_login_redirect_url&&(a=(({baseUrl:e,url:t})=>t.startsWith("/")?`${e}${t}`:new URL(t).origin===e?t:e)({baseUrl:new URL(E.redirectURL).origin,url:s.post_login_redirect_url}));try{const r=await fetch(E.issuerURL+E.issuerRoutes.token,{method:"POST",headers:new Headers({"Content-type":"application/x-www-form-urlencoded; charset=UTF-8","Kinde-SDK":'"NextJS"/1.8.25'}),body:new URLSearchParams({client_id:E.clientID,client_secret:E.clientSecret,code:n,code_verifier:o,grant_type:"authorization_code",redirect_uri:P(E.redirectURL,E.redirectRoutes.callback)})}),s=await r.json();console.log("look here",s);const i=e(s.access_token,{header:!0}),a=e(s.access_token);let c=!0;E.audience&&(c=a.aud&&a.aud.includes(E.audience)),a.iss===E.issuerURL&&"RS256"===i.alg&&a.exp>Math.floor(Date.now()/1e3)&&c?t().set({name:"kinde_token",value:JSON.stringify(s),httpOnly:!0,expires:new Date(1e3*a.exp),sameSite:"lax",secure:"https:"==E.redirectURL.substring(0,6),path:"/"}):console.error("One or more of the claims were not verified.")}catch(e){console.error({err:e})}r(a)}else{const e=new URL(E.issuerURL+E.issuerRoutes.logout);e.searchParams.set("redirect",E.postLogoutRedirectURL),r(e.href)}}};async function x(e,t){const r=(e=>T[e])(t);return r?await r(e):new Response("This page could not be found.",{status:404})}const $=r=>{const o=t().get("kinde_token");if(o){return e(JSON.parse(o.value).access_token)}return{message:"There is no kinde_token, you are not authenticated. Try logging in."}},D=r=>{const o=t().get("kinde_token");if(o){return e(JSON.parse(o.value).id_token)}},C=e=>{const t=$();return t?t[e]:null},j={s:"string",i:"integer",b:"boolean"},K=(e,t,r)=>{const o=C("feature_flags"),n=o&&o[e]?o[e]:{};if(n=={}&&null==t)throw Error(`Flag ${e} was not found, and no default value has been provided`);if(r&&n.t&&r!==n.t)throw Error(`Flag ${e} is of type ${j[n.t]} - requested type ${j[r]}`);return{code:e,type:j[n.t||r],value:null==n.v?t:n.v,is_default:null==n.v}},F=e=>{const t=D();return t?{id:t.sub,given_name:t.given_name,family_name:t.family_name,email:t.email,picture:t.picture}:void 0};var J=Object.freeze({__proto__:null,getAccessToken:$,getBooleanFlag:(e,t)=>{try{return K(e,t,"b").value}catch(e){console.error(e)}},getFlag:K,getIdToken:D,getIntegerFlag:(e,t)=>{try{return K(e,t,"i").value}catch(e){console.error(e)}},getOrganization:()=>({orgCode:C("org_code")}),getPermission:e=>{const t=C("org_code");return{isGranted:(C("permissions")||[]).some((t=>t===e)),orgCode:t}},getPermissions:()=>{const e=C("org_code");return{permissions:C("permissions"),orgCode:e}},getStringFlag:(e,t)=>{try{return K(e,t,"s").value}catch(e){console.error(e)}},getUserOrganizations:e=>({orgCodes:(e=>{const t=D();return t?t[e]:null})("org_codes")}),getUser:F,isAuthenticated:e=>Boolean(F())});const z=e=>e&&"/"===e.charAt(e.length-1)?e.slice(0,-1):e;function H(t){let r=!1;const o=z(t.nextUrl.href),n=z(E.postLogoutRedirectURL),i=t.cookies.get("kinde_token"),a=o===n;return i&&(e(JSON.parse(i.value).access_token),r=!0),r||a?r&&a?s.redirect(new URL(E.postLoginRedirectURL)):s.next():s.redirect(new URL(E.postLogoutRedirectURL,t.url))}function q(){return q=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var o in r)Object.prototype.hasOwnProperty.call(r,o)&&(e[o]=r[o])}return e},q.apply(this,arguments)}function B({children:e,orgCode:t,postLoginRedirectURL:r,...o}){let n=new URLSearchParams;return null!=t&&n.append("org_code",t),null!=r&&n.append("post_login_redirect_url",r),i.createElement("a",q({href:`${E.apiPath}/register${n?`?${n.toString()}`:""}`},o),e)}function G({children:e,postLoginRedirectURL:t,orgCode:r,...o}){let n=new URLSearchParams;return null!=r&&n.append("org_code",r),null!=t&&n.append("post_login_redirect_url",t),i.createElement("a",q({href:`${E.apiPath}/login${n?`?${n.toString()}`:""}`},o),e)}function M({children:e,...t}){return i.createElement("a",q({href:`${E.apiPath}/logout`},t),e)}function W({children:e,orgName:t,...r}){return i.createElement("a",q({href:`${E.apiPath}/create_org${t?`?org_name=${t}`:""}`},r),e)}var X=require("cookie");const V=(e,r)=>e?(e=>e instanceof Request)(e)?Q(t()):Y(e,r):Q(t()),Q=e=>({getSessionItem:t=>{const r=e.get(t);if(r)try{const e=JSON.parse(r.value);return"object"==typeof e?e:r.value}catch(e){return r.value}},setSessionItem:(t,r)=>e.set(t,"object"==typeof r?JSON.stringify(r):r),removeSessionItem:t=>e.delete(t),destroySession:()=>{["id_token_payload","id_token","access_token_payload","access_token","user","refresh_token"].forEach((t=>e.delete(t)))}}),Y=(e,t)=>({getSessionItem:t=>{const r=e.cookies[t];if(r)try{const e=JSON.parse(r);return"object"==typeof e?e:r}catch(e){return r}},setSessionItem:(e,r)=>{let o=t.getHeader("Set-Cookie")||[];Array.isArray(o)||(o=[o]),t.setHeader("Set-Cookie",[...o.filter((t=>!t.startsWith(`${e}=`))),X.serialize(e,"object"==typeof r?JSON.stringify(r):r,{path:"/"})])},removeSessionItem:e=>{t.setHeader("Set-Cookie",X.serialize(e,"",{path:"/",maxAge:-1}))},destroySession:()=>{t.setHeader("Set-Cookie",["id_token_payload","id_token","access_token_payload","access_token","user","refresh_token"].map((e=>X.serialize(e,"",{path:"/",maxAge:-1}))))}}),Z=async(t,r)=>{let o=null;const n=V(t,r),s=n.getSessionItem("kinde_api_access_token");if((t=>{const r=t&&t.access_token||t;if(!r)return!1;const o=e(r,{header:!0}),n=e(r);let s=!0;return E.audience&&(s=n.aud&&n.aud.includes(E.audience)),!!(n.iss==E.issuerURL&&"RS256"==o.alg&&n.exp>Math.floor(Date.now()/1e3)&&s)})(s))o=s;else{const e=await fetch(`${E.issuerURL}/oauth2/token`,{method:"POST",headers:{"content-type":"application/x-www-form-urlencoded"},body:new URLSearchParams({grant_type:"client_credentials",client_id:E.clientID,client_secret:E.clientSecret,audience:E.audience})});o=(await e.json()).access_token,n.setSessionItem("kinde_api_access_token",o)}const i=new a({basePath:E.issuerURL,accessToken:o,headers:{Accept:"application/json"}});return{usersApi:new c(i),oauthApi:new l(i),subscribersApi:new u(i),organizationsApi:new d(i),connectedAppsApi:new _(i),featureFlagsApi:new p(i),environmentsApi:new g(i),permissionsApi:new h(i),rolesApi:new m(i),businessApi:new f(i),industriesApi:new R(i),timezonesApi:new S(i),applicationsApi:new U(i),callbacksApi:new k(i),apisApi:new L(i)}},ee=()=>J;export{W as CreateOrgLink,G as LoginLink,M as LogoutLink,B as RegisterLink,H as authMiddleware,Z as createKindeManagementAPIClient,ee as getKindeServerSession,x as handleAuth};
//# sourceMappingURL=index.js.map
